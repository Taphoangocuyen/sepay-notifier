<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sepay Voice Notifier</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen p-8">
    <div class="max-w-6xl mx-auto">
        <div class="bg-white rounded-2xl shadow-xl p-8">
            <!-- Header -->
            <div class="flex items-center justify-between mb-8">
                <div class="flex items-center gap-3">
                    <div class="bg-indigo-600 p-3 rounded-xl">
                        <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"/>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-3xl font-bold text-gray-800">Sepay Voice Notifier</h1>
                        <p class="text-gray-500">Gi·ªçng n√≥i ti·∫øng Vi·ªát - Render Cloud</p>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <div id="statusIndicator" class="flex items-center gap-2 px-4 py-2 rounded-lg bg-gray-200">
                        <div class="w-3 h-3 rounded-full bg-gray-400"></div>
                        <span class="font-medium text-gray-700">Ch∆∞a k·∫øt n·ªëi</span>
                    </div>
                    <button id="toggleBtn" onclick="toggleConnection()" 
                            class="px-6 py-3 rounded-xl font-semibold bg-indigo-600 hover:bg-indigo-700 text-white transition-all">
                        B·∫Øt ƒë·∫ßu
                    </button>
                </div>
            </div>

            <!-- Main Content Grid -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                <!-- Settings Panel -->
                <div class="bg-indigo-50 rounded-xl p-6">
                    <h2 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                        <svg class="w-5 h-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                        </svg>
                        C√†i ƒë·∫∑t
                    </h2>
                    
                    <div class="space-y-4">
                        <div class="bg-green-50 border-l-4 border-green-400 p-4">
                            <p class="text-sm font-semibold text-green-800 mb-1">‚úÖ Gi·ªçng n√≥i ti·∫øng Vi·ªát</p>
                            <p class="text-xs text-green-700">Google Translate TTS - ƒê·ªçc s·ªë b·∫±ng ch·ªØ</p>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                √Çm l∆∞·ª£ng: <span id="volumeValue">100</span>%
                            </label>
                            <input type="range" id="volumeSlider" min="0" max="100" value="100" 
                                   class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                T·ªëc ƒë·ªô ƒë·ªçc: <span id="rateValue">1.0</span>x
                            </label>
                            <input type="range" id="rateSlider" min="0.5" max="2" step="0.1" value="1" 
                                   class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                URL Render Server
                            </label>
                            <input type="text" id="serverUrl" value="https://sepay-notifier.onrender.com" 
                                   placeholder="https://sepay-notifier.onrender.com"
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                            <p class="text-xs text-gray-500 mt-1">Thay YOUR-APP b·∫±ng t√™n app c·ªßa b·∫°n</p>
                        </div>

                        <button onclick="testVoice()" 
                                class="w-full px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white font-medium rounded-lg transition-colors">
                            üîä Test gi·ªçng ƒë·ªçc
                        </button>
                    </div>
                </div>

                <!-- Server Info Panel -->
                <div class="bg-green-50 rounded-xl p-6">
                    <h2 class="text-lg font-semibold text-gray-800 mb-4">Th√¥ng tin k·∫øt n·ªëi</h2>
                    
                    <div class="space-y-4">
                        <div class="bg-white rounded-lg p-4 border border-green-200">
                            <p class="text-sm font-medium text-gray-700 mb-2">Webhook URL cho Sepay:</p>
                            <code id="webhookUrl" class="block text-sm text-gray-600 break-all bg-gray-50 p-3 rounded">
                                Ch∆∞a c√≥ (Kh·ªüi ƒë·ªông server tr∆∞·ªõc)
                            </code>
                            <button onclick="copyWebhookUrl()" class="mt-2 text-xs text-indigo-600 hover:text-indigo-700 font-medium">
                                üìã Copy URL
                            </button>
                        </div>

                        <div class="bg-white rounded-lg p-4 border border-green-200">
                            <p class="text-sm font-medium text-gray-700 mb-2">Tr·∫°ng th√°i WebSocket:</p>
                            <p id="wsStatus" class="text-sm text-gray-600">‚ö™ Ch∆∞a k·∫øt n·ªëi</p>
                        </div>

                        <div class="bg-blue-50 border-l-4 border-blue-400 p-4">
                            <p class="text-sm font-semibold text-blue-800 mb-2">‚òÅÔ∏è Render Cloud:</p>
                            <ul class="text-xs text-blue-700 space-y-1">
                                <li>‚úÖ Server ch·∫°y 24/7 tr√™n cloud</li>
                                <li>‚úÖ Kh√¥ng c·∫ßn m√°y t√≠nh b·∫≠t</li>
                                <li>‚ö†Ô∏è L·∫ßn ƒë·∫ßu k·∫øt n·ªëi c√≥ th·ªÉ ch·∫≠m (30s)</li>
                                <li>üí° WebSocket: wss://</li>
                            </ul>
                        </div>

                        <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4">
                            <p class="text-sm font-semibold text-yellow-800 mb-2">üìù H∆∞·ªõng d·∫´n:</p>
                            <ol class="text-xs text-yellow-700 space-y-1 list-decimal list-inside">
                                <li>ƒê·∫£m b·∫£o server ƒë√£ deploy tr√™n Render</li>
                                <li>Nh·∫≠p ƒë√∫ng URL Render ·ªü tr√™n</li>
                                <li>Nh·∫•n "B·∫Øt ƒë·∫ßu"</li>
                                <li>Copy Webhook URL v√†o Sepay</li>
                                <li>Gi·ªØ tab n√†y m·ªü</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Transaction History -->
            <div class="bg-gray-50 rounded-xl p-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-semibold text-gray-800 flex items-center gap-2">
                        <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        L·ªãch s·ª≠ giao d·ªãch
                    </h2>
                    <button onclick="clearHistory()" class="text-sm text-red-600 hover:text-red-700">
                        X√≥a l·ªãch s·ª≠
                    </button>
                </div>
                
                <div id="transactionList" class="space-y-3">
                    <p class="text-gray-500 text-center py-8">Ch∆∞a c√≥ giao d·ªãch n√†o</p>
                </div>
            </div>
        </div>

        <!-- Info Banner -->
        <div class="mt-8 bg-indigo-50 border-l-4 border-indigo-400 p-6 rounded-lg">
            <h3 class="font-semibold text-indigo-800 mb-2">üöÄ Deploy tr√™n Render</h3>
            <ul class="text-sm text-indigo-700 space-y-1">
                <li>‚úÖ Server ch·∫°y tr√™n cloud mi·ªÖn ph√≠</li>
                <li>‚úÖ Kh√¥ng c·∫ßn m√°y t√≠nh b·∫≠t</li>
                <li>‚úÖ URL c·ªë ƒë·ªãnh, kh√¥ng thay ƒë·ªïi</li>
                <li>‚ö†Ô∏è Free plan: Server ng·ªß sau 15 ph√∫t kh√¥ng d√πng</li>
                <li>üí° Khi c√≥ webhook m·ªõi, server t·ª± th·ª©c d·∫≠y (ch·∫≠m 30-60s)</li>
            </ul>
        </div>
    </div>

    <script>
        let ws = null;
        let isConnected = false;
        let transactions = [];
        let reconnectAttempts = 0;
        const MAX_RECONNECT_ATTEMPTS = 5;

        // Volume and rate sliders
        document.getElementById('volumeSlider').addEventListener('input', (e) => {
            document.getElementById('volumeValue').textContent = e.target.value;
        });

        document.getElementById('rateSlider').addEventListener('input', (e) => {
            document.getElementById('rateValue').textContent = parseFloat(e.target.value).toFixed(1);
        });

        // Chuy·ªÉn ƒë·ªïi s·ªë th√†nh ch·ªØ ti·∫øng Vi·ªát
        function numberToVietnamese(num) {
            if (num === 0) return 'kh√¥ng';
            
            const ones = ['', 'm·ªôt', 'hai', 'ba', 'b·ªën', 'nƒÉm', 's√°u', 'b·∫£y', 't√°m', 'ch√≠n'];
            const teens = ['m∆∞·ªùi', 'm∆∞·ªùi m·ªôt', 'm∆∞·ªùi hai', 'm∆∞·ªùi ba', 'm∆∞·ªùi b·ªën', 'm∆∞·ªùi lƒÉm', 'm∆∞·ªùi s√°u', 'm∆∞·ªùi b·∫£y', 'm∆∞·ªùi t√°m', 'm∆∞·ªùi ch√≠n'];
            
            function convertUnderThousand(n) {
                if (n === 0) return '';
                if (n < 10) return ones[n];
                if (n < 20) return teens[n - 10];
                
                const hundred = Math.floor(n / 100);
                const remainder = n % 100;
                const ten = Math.floor(remainder / 10);
                const one = remainder % 10;
                
                let result = '';
                
                if (hundred > 0) {
                    result += ones[hundred] + ' trƒÉm';
                    if (remainder > 0 && remainder < 10) result += ' l·∫ª';
                }
                
                if (ten > 1) {
                    result += (result ? ' ' : '') + ones[ten] + ' m∆∞∆°i';
                    if (one === 5) {
                        result += ' lƒÉm';
                    } else if (one > 0) {
                        result += ' ' + ones[one];
                    }
                } else if (ten === 1) {
                    result += (result ? ' ' : '') + 'm∆∞·ªùi';
                    if (one === 5) {
                        result += ' lƒÉm';
                    } else if (one > 0) {
                        result += ' ' + ones[one];
                    }
                } else if (one > 0) {
                    result += (result ? ' ' : '') + ones[one];
                }
                
                return result.trim();
            }
            
            if (num < 1000) {
                return convertUnderThousand(num);
            }
            
            const billion = Math.floor(num / 1000000000);
            const million = Math.floor((num % 1000000000) / 1000000);
            const thousand = Math.floor((num % 1000000) / 1000);
            const remainder = num % 1000;
            
            let result = '';
            
            if (billion > 0) {
                result += convertUnderThousand(billion) + ' t·ª∑';
            }
            
            if (million > 0) {
                result += (result ? ' ' : '') + convertUnderThousand(million) + ' tri·ªáu';
            }
            
            if (thousand > 0) {
                result += (result ? ' ' : '') + convertUnderThousand(thousand) + ' ng√†n';
            }
            
            if (remainder > 0) {
                if (result && remainder < 100) {
                    result += ' l·∫ª';
                }
                result += (result ? ' ' : '') + convertUnderThousand(remainder);
            }
            
            return result.trim();
        }

        // Google Translate TTS function
        function speakVietnamese(text) {
            const volume = document.getElementById('volumeSlider').value / 100;
            const rate = parseFloat(document.getElementById('rateSlider').value);
            
            const encodedText = encodeURIComponent(text);
            const audioUrl = `https://translate.google.com/translate_tts?ie=UTF-8&tl=vi&client=tw-ob&q=${encodedText}`;
            
            const audio = new Audio(audioUrl);
            audio.volume = volume;
            audio.playbackRate = rate;
            
            audio.play().catch(error => {
                console.error('L·ªói ph√°t gi·ªçng n√≥i:', error);
                fallbackSpeak(text);
            });
            
            return audio;
        }

        function fallbackSpeak(text) {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'vi-VN';
                utterance.volume = document.getElementById('volumeSlider').value / 100;
                utterance.rate = parseFloat(document.getElementById('rateSlider').value);
                window.speechSynthesis.speak(utterance);
            }
        }

        function testVoice() {
            speakVietnamese('B·∫°n v·ª´a nh·∫≠n ƒë∆∞·ª£c s·ªë ti·ªÅn nƒÉm trƒÉm ng√†n ƒë·ªìng');
        }

        function copyWebhookUrl() {
            const url = document.getElementById('webhookUrl').textContent;
            navigator.clipboard.writeText(url).then(() => {
                alert('‚úÖ ƒê√£ copy Webhook URL!');
            }).catch(err => {
                console.error('L·ªói copy:', err);
            });
        }

        function toggleConnection() {
            if (isConnected) {
                disconnect();
            } else {
                connect();
            }
        }

        function connect() {
            const serverUrl = document.getElementById('serverUrl').value.trim();
            
            if (!serverUrl) {
                alert('Vui l√≤ng nh·∫≠p URL Render server');
                return;
            }
            
            // Chuy·ªÉn https:// th√†nh wss:// cho WebSocket
            const wsUrl = serverUrl.replace('https://', 'wss://').replace('http://', 'ws://');
            
            console.log('ƒêang k·∫øt n·ªëi ƒë·∫øn:', wsUrl);
            updateStatus('connecting');
            document.getElementById('wsStatus').textContent = 'üü° ƒêang k·∫øt n·ªëi...';
            
            try {
                ws = new WebSocket(wsUrl);
                
                ws.onopen = () => {
                    console.log('‚úì WebSocket connected');
                    isConnected = true;
                    reconnectAttempts = 0;
                    updateStatus('connected');
                    document.getElementById('wsStatus').textContent = 'üü¢ ƒê√£ k·∫øt n·ªëi';
                    document.getElementById('webhookUrl').textContent = serverUrl + '/webhook';
                    speakVietnamese('ƒê√£ k·∫øt n·ªëi th√†nh c√¥ng');
                };
                
                ws.onmessage = (event) => {
                    try {
                        const message = JSON.parse(event.data);
                        console.log('Nh·∫≠n message:', message);
                        
                        if (message.type === 'transaction') {
                            handleTransaction(message.data);
                        }
                    } catch (error) {
                        console.error('L·ªói parse message:', error);
                    }
                };
                
                ws.onerror = (error) => {
                    console.error('WebSocket error:', error);
                    updateStatus('error');
                    document.getElementById('wsStatus').textContent = 'üî¥ L·ªói k·∫øt n·ªëi - Ki·ªÉm tra URL ho·∫∑c server c√≥ ƒëang ch·∫°y?';
                };
                
                ws.onclose = (event) => {
                    console.log('WebSocket closed:', event.code, event.reason);
                    isConnected = false;
                    
                    if (reconnectAttempts < MAX_RECONNECT_ATTEMPTS && !event.wasClean) {
                        reconnectAttempts++;
                        document.getElementById('wsStatus').textContent = `üü° Th·ª≠ k·∫øt n·ªëi l·∫°i... (${reconnectAttempts}/${MAX_RECONNECT_ATTEMPTS})`;
                        setTimeout(() => connect(), 3000);
                    } else {
                        updateStatus('disconnected');
                        document.getElementById('wsStatus').textContent = '‚ö™ ƒê√£ ng·∫Øt k·∫øt n·ªëi';
                    }
                };
                
            } catch (error) {
                console.error('L·ªói t·∫°o WebSocket:', error);
                updateStatus('error');
                document.getElementById('wsStatus').textContent = 'üî¥ L·ªói: ' + error.message;
            }
        }

        function disconnect() {
            if (ws) {
                ws.close();
                ws = null;
            }
            isConnected = false;
            reconnectAttempts = 0;
            updateStatus('disconnected');
        }

        function updateStatus(status) {
            const indicator = document.getElementById('statusIndicator');
            const btn = document.getElementById('toggleBtn');
            
            if (status === 'connecting') {
                indicator.innerHTML = `
                    <div class="w-3 h-3 rounded-full bg-yellow-500 animate-pulse"></div>
                    <span class="font-medium text-yellow-700">ƒêang k·∫øt n·ªëi...</span>
                `;
                indicator.className = 'flex items-center gap-2 px-4 py-2 rounded-lg bg-yellow-100';
                btn.disabled = true;
                btn.className = 'px-6 py-3 rounded-xl font-semibold bg-gray-400 text-white cursor-not-allowed';
            } else if (status === 'connected') {
                indicator.innerHTML = `
                    <div class="w-3 h-3 rounded-full bg-green-500 animate-pulse"></div>
                    <span class="font-medium text-green-700">ƒêang ho·∫°t ƒë·ªông</span>
                `;
                indicator.className = 'flex items-center gap-2 px-4 py-2 rounded-lg bg-green-100';
                btn.textContent = 'D·ª´ng l·∫°i';
                btn.disabled = false;
                btn.className = 'px-6 py-3 rounded-xl font-semibold bg-red-500 hover:bg-red-600 text-white transition-all';
            } else if (status === 'error') {
                indicator.innerHTML = `
                    <div class="w-3 h-3 rounded-full bg-red-500"></div>
                    <span class="font-medium text-red-700">L·ªói k·∫øt n·ªëi</span>
                `;
                indicator.className = 'flex items-center gap-2 px-4 py-2 rounded-lg bg-red-100';
                btn.textContent = 'Th·ª≠ l·∫°i';
                btn.disabled = false;
                btn.className = 'px-6 py-3 rounded-xl font-semibold bg-indigo-600 hover:bg-indigo-700 text-white transition-all';
            } else {
                indicator.innerHTML = `
                    <div class="w-3 h-3 rounded-full bg-gray-400"></div>
                    <span class="font-medium text-gray-700">Ch∆∞a k·∫øt n·ªëi</span>
                `;
                indicator.className = 'flex items-center gap-2 px-4 py-2 rounded-lg bg-gray-200';
                btn.textContent = 'B·∫Øt ƒë·∫ßu';
                btn.disabled = false;
                btn.className = 'px-6 py-3 rounded-xl font-semibold bg-indigo-600 hover:bg-indigo-700 text-white transition-all';
            }
        }

        function handleTransaction(data) {
            const amount = data.amount || data.transferAmount || 0;
            const content = data.content || data.description || 'Kh√¥ng c√≥ n·ªôi dung';
            const sender = data.account_name || data.accountName || 'Kh√¥ng r√µ';
            
            const transaction = {
                id: Date.now(),
                amount: amount,
                content: content,
                sender: sender,
                time: new Date().toLocaleTimeString('vi-VN')
            };
            
            transactions.unshift(transaction);
            if (transactions.length > 10) transactions.pop();
            
            renderTransactions();
            
            const amountInWords = numberToVietnamese(amount);
            const message = `B·∫°n v·ª´a nh·∫≠n ƒë∆∞·ª£c s·ªë ti·ªÅn ${amountInWords} ƒë·ªìng`;
            
            speakVietnamese(message);
        }

        function renderTransactions() {
            const list = document.getElementById('transactionList');
            if (transactions.length === 0) {
                list.innerHTML = '<p class="text-gray-500 text-center py-8">Ch∆∞a c√≥ giao d·ªãch n√†o</p>';
                return;
            }
            
            list.innerHTML = transactions.map(t => `
                <div class="bg-white rounded-lg p-4 border border-gray-200 hover:shadow-md transition-shadow">
                    <div class="flex justify-between items-start mb-2">
                        <span class="text-2xl font-bold text-green-600">
                            ${t.amount.toLocaleString('vi-VN')} ‚Ç´
                        </span>
                        <span class="text-sm text-gray-500">${t.time}</span>
                    </div>
                    <p class="text-sm text-gray-700 mb-1">
                        <strong>T·ª´:</strong> ${t.sender}
                    </p>
                    <p class="text-sm text-gray-600">
                        <strong>N·ªôi dung:</strong> ${t.content}
                    </p>
                </div>
            `).join('');
        }

        function clearHistory() {
            if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a l·ªãch s·ª≠?')) {
                transactions = [];
                renderTransactions();
            }
        }

        // Auto-connect on page load if URL is set
        window.addEventListener('load', () => {
            const serverUrl = document.getElementById('serverUrl').value;
            if (serverUrl && serverUrl !== 'https://sepay-notifier.onrender.com') {
                console.log('URL ƒë√£ ƒë∆∞·ª£c c·∫•u h√¨nh, c√≥ th·ªÉ t·ª± ƒë·ªông k·∫øt n·ªëi');
            }
        });
    </script>
</body>
</html>