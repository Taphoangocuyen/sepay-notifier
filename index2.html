<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sepay Voice Notifier - Google TTS</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen p-8">
    <div class="max-w-6xl mx-auto">
        <div class="bg-white rounded-2xl shadow-xl p-8">
            <!-- Header -->
            <div class="flex items-center justify-between mb-8">
                <div class="flex items-center gap-3">
                    <div class="bg-indigo-600 p-3 rounded-xl">
                        <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"/>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-3xl font-bold text-gray-800">Sepay Voice Notifier</h1>
                        <p class="text-gray-500">Gi·ªçng n√≥i ti·∫øng Vi·ªát v·ªõi Google Translate</p>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <div id="statusIndicator" class="flex items-center gap-2 px-4 py-2 rounded-lg bg-gray-200">
                        <div class="w-3 h-3 rounded-full bg-gray-400"></div>
                        <span class="font-medium text-gray-700">Ch∆∞a k·∫øt n·ªëi</span>
                    </div>
                    <button id="toggleBtn" onclick="toggleConnection()" 
                            class="px-6 py-3 rounded-xl font-semibold bg-indigo-600 hover:bg-indigo-700 text-white transition-all">
                        B·∫Øt ƒë·∫ßu
                    </button>
                </div>
            </div>

            <!-- Main Content Grid -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                <!-- Settings Panel -->
                <div class="bg-indigo-50 rounded-xl p-6">
                    <h2 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                        <svg class="w-5 h-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                        </svg>
                        C√†i ƒë·∫∑t
                    </h2>
                    
                    <div class="space-y-4">
                        <div class="bg-green-50 border-l-4 border-green-400 p-4">
                            <p class="text-sm font-semibold text-green-800 mb-1">‚úÖ Gi·ªçng n√≥i ti·∫øng Vi·ªát</p>
                            <p class="text-xs text-green-700">S·ª≠ d·ª•ng Google Translate TTS - Kh√¥ng c·∫ßn c√†i ƒë·∫∑t!</p>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                √Çm l∆∞·ª£ng: <span id="volumeValue">100</span>%
                            </label>
                            <input type="range" id="volumeSlider" min="0" max="100" value="100" 
                                   class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                T·ªëc ƒë·ªô ƒë·ªçc: <span id="rateValue">1.0</span>x
                            </label>
                            <input type="range" id="rateSlider" min="0.5" max="2" step="0.1" value="1" 
                                   class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                URL Backend Server
                            </label>
                            <input type="text" id="serverUrl" value="http://localhost:3000" 
                                   placeholder="http://localhost:3000"
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        </div>

                        <button onclick="testVoice()" 
                                class="w-full px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white font-medium rounded-lg transition-colors">
                            üîä Test gi·ªçng ƒë·ªçc
                        </button>
                    </div>
                </div>

                <!-- Server Info Panel -->
                <div class="bg-green-50 rounded-xl p-6">
                    <h2 class="text-lg font-semibold text-gray-800 mb-4">Th√¥ng tin k·∫øt n·ªëi</h2>
                    
                    <div class="space-y-4">
                        <div class="bg-white rounded-lg p-4 border border-green-200">
                            <p class="text-sm font-medium text-gray-700 mb-2">Webhook URL cho Sepay:</p>
                            <code id="webhookUrl" class="block text-sm text-gray-600 break-all bg-gray-50 p-3 rounded">
                                Ch∆∞a c√≥ (Kh·ªüi ƒë·ªông server tr∆∞·ªõc)
                            </code>
                        </div>

                        <div class="bg-white rounded-lg p-4 border border-green-200">
                            <p class="text-sm font-medium text-gray-700 mb-2">Tr·∫°ng th√°i WebSocket:</p>
                            <p id="wsStatus" class="text-sm text-gray-600">‚ö™ Ch∆∞a k·∫øt n·ªëi</p>
                        </div>

                        <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4">
                            <p class="text-sm font-semibold text-yellow-800 mb-2">üìù H∆∞·ªõng d·∫´n:</p>
                            <ol class="text-xs text-yellow-700 space-y-1 list-decimal list-inside">
                                <li>Ch·∫°y server: <code class="bg-yellow-100 px-1">node server.js</code></li>
                                <li>Nh·∫•n "B·∫Øt ƒë·∫ßu" ·ªü tr√™n</li>
                                <li>Test gi·ªçng ƒë·ªçc ti·∫øng Vi·ªát</li>
                                <li>Copy Webhook URL v√†o Sepay</li>
                                <li>Gi·ªØ tab n√†y m·ªü</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Transaction History -->
            <div class="bg-gray-50 rounded-xl p-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-semibold text-gray-800 flex items-center gap-2">
                        <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        L·ªãch s·ª≠ giao d·ªãch
                    </h2>
                    <button onclick="clearHistory()" class="text-sm text-red-600 hover:text-red-700">
                        X√≥a l·ªãch s·ª≠
                    </button>
                </div>
                
                <div id="transactionList" class="space-y-3">
                    <p class="text-gray-500 text-center py-8">Ch∆∞a c√≥ giao d·ªãch n√†o</p>
                </div>
            </div>
        </div>

        <!-- Info Banner -->
        <div class="mt-8 bg-blue-50 border-l-4 border-blue-400 p-6 rounded-lg">
            <h3 class="font-semibold text-blue-800 mb-2">üí° V·ªÅ gi·ªçng ƒë·ªçc Google Translate</h3>
            <ul class="text-sm text-blue-700 space-y-1">
                <li>‚úÖ Gi·ªçng n√≥i ti·∫øng Vi·ªát t·ª± nhi√™n, kh√¥ng c·∫ßn c√†i ƒë·∫∑t</li>
                <li>‚úÖ Ho·∫°t ƒë·ªông tr√™n m·ªçi tr√¨nh duy·ªát v√† h·ªá ƒëi·ªÅu h√†nh</li>
                <li>‚úÖ C·∫ßn k·∫øt n·ªëi internet ƒë·ªÉ ph√°t gi·ªçng n√≥i</li>
                <li>‚ö†Ô∏è C√≥ ƒë·ªô tr·ªÖ nh·ªè khi t·∫£i audio t·ª´ Google (1-2 gi√¢y)</li>
            </ul>
        </div>
    </div>

    <script>
        let ws = null;
        let isConnected = false;
        let transactions = [];
        let audioQueue = [];
        let isPlaying = false;

        // Volume and rate sliders
        document.getElementById('volumeSlider').addEventListener('input', (e) => {
            document.getElementById('volumeValue').textContent = e.target.value;
        });

        document.getElementById('rateSlider').addEventListener('input', (e) => {
            document.getElementById('rateValue').textContent = parseFloat(e.target.value).toFixed(1);
        });

        // Chuy·ªÉn ƒë·ªïi s·ªë th√†nh ch·ªØ ti·∫øng Vi·ªát
        function numberToVietnamese(num) {
            if (num === 0) return 'kh√¥ng';
            
            const ones = ['', 'm·ªôt', 'hai', 'ba', 'b·ªën', 'nƒÉm', 's√°u', 'b·∫£y', 't√°m', 'ch√≠n'];
            const teens = ['m∆∞·ªùi', 'm∆∞·ªùi m·ªôt', 'm∆∞·ªùi hai', 'm∆∞·ªùi ba', 'm∆∞·ªùi b·ªën', 'm∆∞·ªùi lƒÉm', 'm∆∞·ªùi s√°u', 'm∆∞·ªùi b·∫£y', 'm∆∞·ªùi t√°m', 'm∆∞·ªùi ch√≠n'];
            
            function convertUnderThousand(n) {
                if (n === 0) return '';
                if (n < 10) return ones[n];
                if (n < 20) return teens[n - 10];
                
                const hundred = Math.floor(n / 100);
                const remainder = n % 100;
                const ten = Math.floor(remainder / 10);
                const one = remainder % 10;
                
                let result = '';
                
                if (hundred > 0) {
                    result += ones[hundred] + ' trƒÉm';
                    if (remainder > 0 && remainder < 10) result += ' l·∫ª';
                }
                
                if (ten > 1) {
                    result += (result ? ' ' : '') + ones[ten] + ' m∆∞∆°i';
                    if (one === 5) {
                        result += ' lƒÉm';
                    } else if (one > 0) {
                        result += ' ' + ones[one];
                    }
                } else if (ten === 1) {
                    result += (result ? ' ' : '') + 'm∆∞·ªùi';
                    if (one === 5) {
                        result += ' lƒÉm';
                    } else if (one > 0) {
                        result += ' ' + ones[one];
                    }
                } else if (one > 0) {
                    result += (result ? ' ' : '') + ones[one];
                }
                
                return result.trim();
            }
            
            if (num < 1000) {
                return convertUnderThousand(num);
            }
            
            const billion = Math.floor(num / 1000000000);
            const million = Math.floor((num % 1000000000) / 1000000);
            const thousand = Math.floor((num % 1000000) / 1000);
            const remainder = num % 1000;
            
            let result = '';
            
            if (billion > 0) {
                result += convertUnderThousand(billion) + ' t·ª∑';
            }
            
            if (million > 0) {
                result += (result ? ' ' : '') + convertUnderThousand(million) + ' tri·ªáu';
            }
            
            if (thousand > 0) {
                result += (result ? ' ' : '') + convertUnderThousand(thousand) + ' ng√†n';
            }
            
            if (remainder > 0) {
                if (result && remainder < 100) {
                    result += ' l·∫ª';
                }
                result += (result ? ' ' : '') + convertUnderThousand(remainder);
            }
            
            return result.trim();
        }

        // Google Translate TTS function
        function speakVietnamese(text) {
            const volume = document.getElementById('volumeSlider').value / 100;
            const rate = parseFloat(document.getElementById('rateSlider').value);
            
            // Encode text for URL
            const encodedText = encodeURIComponent(text);
            
            // Google Translate TTS URL
            const audioUrl = `https://translate.google.com/translate_tts?ie=UTF-8&tl=vi&client=tw-ob&q=${encodedText}`;
            
            // Create and play audio
            const audio = new Audio(audioUrl);
            audio.volume = volume;
            audio.playbackRate = rate;
            
            audio.play().catch(error => {
                console.error('L·ªói ph√°t gi·ªçng n√≥i:', error);
                // Fallback: Try with browser TTS
                fallbackSpeak(text);
            });
            
            return audio;
        }

        // Fallback to browser TTS if Google fails
        function fallbackSpeak(text) {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'vi-VN';
                utterance.volume = document.getElementById('volumeSlider').value / 100;
                utterance.rate = parseFloat(document.getElementById('rateSlider').value);
                window.speechSynthesis.speak(utterance);
            }
        }

        function testVoice() {
            speakVietnamese('B·∫°n v·ª´a nh·∫≠n ƒë∆∞·ª£c s·ªë ti·ªÅn nƒÉm trƒÉm ng√†n ƒë·ªìng');
        }

        function toggleConnection() {
            if (isConnected) {
                disconnect();
            } else {
                connect();
            }
        }

        function connect() {
            const serverUrl = document.getElementById('serverUrl').value;
            const wsUrl = serverUrl.replace('http://', 'ws://').replace('https://', 'wss://').replace(':3000', ':8080');
            
            ws = new WebSocket(wsUrl);
            
            ws.onopen = () => {
                isConnected = true;
                updateStatus('connected');
                document.getElementById('wsStatus').textContent = 'üü¢ ƒê√£ k·∫øt n·ªëi';
                document.getElementById('webhookUrl').textContent = serverUrl + '/webhook';
                speakVietnamese('ƒê√£ k·∫øt n·ªëi th√†nh c√¥ng');
            };
            
            ws.onmessage = (event) => {
                const message = JSON.parse(event.data);
                if (message.type === 'transaction') {
                    handleTransaction(message.data);
                }
            };
            
            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
                updateStatus('error');
                document.getElementById('wsStatus').textContent = 'üî¥ L·ªói k·∫øt n·ªëi';
            };
            
            ws.onclose = () => {
                isConnected = false;
                updateStatus('disconnected');
                document.getElementById('wsStatus').textContent = '‚ö™ ƒê√£ ng·∫Øt k·∫øt n·ªëi';
            };
        }

        function disconnect() {
            if (ws) {
                ws.close();
                ws = null;
            }
            isConnected = false;
            updateStatus('disconnected');
        }

        function updateStatus(status) {
            const indicator = document.getElementById('statusIndicator');
            const btn = document.getElementById('toggleBtn');
            
            if (status === 'connected') {
                indicator.innerHTML = `
                    <div class="w-3 h-3 rounded-full bg-green-500 animate-pulse"></div>
                    <span class="font-medium text-green-700">ƒêang ho·∫°t ƒë·ªông</span>
                `;
                indicator.className = 'flex items-center gap-2 px-4 py-2 rounded-lg bg-green-100';
                btn.textContent = 'D·ª´ng l·∫°i';
                btn.className = 'px-6 py-3 rounded-xl font-semibold bg-red-500 hover:bg-red-600 text-white transition-all';
            } else if (status === 'error') {
                indicator.innerHTML = `
                    <div class="w-3 h-3 rounded-full bg-red-500"></div>
                    <span class="font-medium text-red-700">L·ªói k·∫øt n·ªëi</span>
                `;
                indicator.className = 'flex items-center gap-2 px-4 py-2 rounded-lg bg-red-100';
                btn.textContent = 'Th·ª≠ l·∫°i';
                btn.className = 'px-6 py-3 rounded-xl font-semibold bg-indigo-600 hover:bg-indigo-700 text-white transition-all';
            } else {
                indicator.innerHTML = `
                    <div class="w-3 h-3 rounded-full bg-gray-400"></div>
                    <span class="font-medium text-gray-700">Ch∆∞a k·∫øt n·ªëi</span>
                `;
                indicator.className = 'flex items-center gap-2 px-4 py-2 rounded-lg bg-gray-200';
                btn.textContent = 'B·∫Øt ƒë·∫ßu';
                btn.className = 'px-6 py-3 rounded-xl font-semibold bg-indigo-600 hover:bg-indigo-700 text-white transition-all';
            }
        }

        function handleTransaction(data) {
            const amount = data.amount || data.transferAmount || 0;
            const content = data.content || data.description || 'Kh√¥ng c√≥ n·ªôi dung';
            const sender = data.account_name || data.accountName || 'Kh√¥ng r√µ';
            
            const transaction = {
                id: Date.now(),
                amount: amount,
                content: content,
                sender: sender,
                time: new Date().toLocaleTimeString('vi-VN')
            };
            
            transactions.unshift(transaction);
            if (transactions.length > 10) transactions.pop();
            
            renderTransactions();
            
            // Chuy·ªÉn s·ªë th√†nh ch·ªØ ti·∫øng Vi·ªát
            const amountInWords = numberToVietnamese(amount);
            const message = `B·∫°n v·ª´a nh·∫≠n ƒë∆∞·ª£c s·ªë ti·ªÅn ${amountInWords} ƒë·ªìng`;
            
            speakVietnamese(message);
        }

        function renderTransactions() {
            const list = document.getElementById('transactionList');
            if (transactions.length === 0) {
                list.innerHTML = '<p class="text-gray-500 text-center py-8">Ch∆∞a c√≥ giao d·ªãch n√†o</p>';
                return;
            }
            
            list.innerHTML = transactions.map(t => `
                <div class="bg-white rounded-lg p-4 border border-gray-200 hover:shadow-md transition-shadow">
                    <div class="flex justify-between items-start mb-2">
                        <span class="text-2xl font-bold text-green-600">
                            ${t.amount.toLocaleString('vi-VN')} ‚Ç´
                        </span>
                        <span class="text-sm text-gray-500">${t.time}</span>
                    </div>
                    <p class="text-sm text-gray-700 mb-1">
                        <strong>T·ª´:</strong> ${t.sender}
                    </p>
                    <p class="text-sm text-gray-600">
                        <strong>N·ªôi dung:</strong> ${t.content}
                    </p>
                </div>
            `).join('');
        }

        function clearHistory() {
            if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a l·ªãch s·ª≠?')) {
                transactions = [];
                renderTransactions();
            }
        }
    </script>
</body>
</html>